<!DOCTYPE html>
<html lang="en" x-data="dashboard()" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Deck | Fleet</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script>
        (function() {
            const theme = localStorage.getItem('theme');
            const isDark = theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.documentElement.style.backgroundColor = '#09090b';
            } else {
                document.documentElement.classList.remove('dark');
                document.documentElement.style.backgroundColor = '#f9fafb';
            }
        })();
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: { 
                        brand: '#10b981', 
                        surface: '#f9fafb',
                        darkBg: '#09090b', 
                        darkCard: '#18181b',
                        darkBorder: '#27272a'
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        
        body {
            transition: background-color 0.8s cubic-bezier(0.4, 0, 0.2, 1), color 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dot-grid {
            position: fixed; inset: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px; pointer-events: none; z-index: -1;
            transition: opacity 0.8s ease;
        }
        .dark .dot-grid { background-image: radial-gradient(#27272a 1px, transparent 1px); }
        
        .grid-mask {
            mask-image: radial-gradient(ellipse at center, black, transparent 90%);
            -webkit-mask-image: radial-gradient(ellipse at center, black, transparent 90%);
        }

        .glow-aura {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% -20%, rgba(16, 185, 129, 0.08), transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }

        .device-card {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        box-shadow 0.4s ease, 
                        border-color 0.4s ease,
                        background-color 0.8s ease;
        }
    </style>
</head>
<body 
    x-init="initPage()"
    :class="{ 'opacity-100': pageLoaded, 'opacity-0': !pageLoaded }"
    class="bg-surface text-zinc-900 dark:bg-darkBg dark:text-zinc-100 min-h-screen font-sans antialiased transition-opacity duration-700 ease-in-out flex flex-col">

    <div class="glow-aura"></div>
    <div class="dot-grid grid-mask"></div>

    <nav x-show="pageLoaded" x-transition:enter="transition ease-out duration-500" x-transition:enter-start="-translate-y-full opacity-0" x-transition:enter-end="translate-y-0 opacity-100"
        class="border-b border-zinc-200 dark:border-darkBorder bg-white/70 dark:bg-darkBg/70 backdrop-blur-xl sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
            <h1 class="text-xl font-bold tracking-tight">Machine<span class="text-brand">Deck</span></h1>
            
            <div class="flex items-center gap-2">
                <button @click="toggleTheme($event)" class="p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all duration-300 active:scale-90">
                    <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg x-show="darkMode" x-cloak class="w-5 h-5 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M4 9h1m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
                <button @click="openAddModal()" class="ml-2 bg-brand hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-lg shadow-emerald-500/20 transition-all">
                    Add Machine
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 py-12 relative flex-grow">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <template x-for="(device, index) in devices" :key="index">
                <div x-show="pageLoaded" x-transition:enter="transition ease-out duration-700" x-transition:enter-start="translate-y-8 opacity-0" x-transition:enter-end="translate-y-0 opacity-100" :style="`transition-delay: ${index * 100}ms`"
                    class="device-card group bg-white/80 dark:bg-darkCard/80 backdrop-blur-sm border border-zinc-200 dark:border-darkBorder rounded-2xl p-5 flex flex-col hover:shadow-2xl hover:-translate-y-1">
                    
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="relative flex h-2 w-2">
                                    <span :class="device.status === 'offline' ? 'bg-red-500' : 'bg-brand'" class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75"></span>
                                    <span :class="device.status === 'offline' ? 'bg-red-500' : 'bg-brand'" class="relative inline-flex rounded-full h-2 w-2"></span>
                                </div>
                                <span class="text-[9px] font-bold uppercase tracking-wider text-zinc-400">
                                    <span x-text="device.status || 'online'"></span> â€¢ <span x-text="device.status === 'offline' ? 'inactive' : 'active'"></span>
                                </span>
                            </div>
                            <span :class="device.type === 'vps' ? 'text-brand' : 'text-zinc-400'" class="text-[10px] font-bold uppercase tracking-widest" x-text="device.type"></span>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button @click="editDevice(index)" class="p-1.5 text-zinc-400 hover:text-brand transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                            <button @click="removeDevice(index)" class="p-1.5 text-zinc-400 hover:text-red-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-50 leading-tight mb-1" x-text="device.name"></h3>
                        <p class="text-zinc-500 dark:text-zinc-400 text-xs leading-relaxed line-clamp-2" x-text="device.description || 'No description'"></p>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-4" x-show="device.specs_cpu || device.specs_ram">
                        <template x-if="device.specs_cpu"><span class="px-2 py-0.5 bg-zinc-100 dark:bg-zinc-800 rounded text-[9px] font-mono text-zinc-500" x-text="device.specs_cpu + ' CPU'"></span></template>
                        <template x-if="device.specs_ram"><span class="px-2 py-0.5 bg-zinc-100 dark:bg-zinc-800 rounded text-[9px] font-mono text-zinc-500" x-text="device.specs_ram + ' RAM'"></span></template>
                    </div>

                    <div class="relative aspect-video rounded-xl overflow-hidden bg-zinc-100 dark:bg-zinc-900 mb-5 border border-zinc-100 dark:border-zinc-800">
                        <img :src="getDisplayImage(device)" class="w-full h-full object-cover grayscale-[0.2] hover:grayscale-0 transition-all duration-500" alt="Preview">
                    </div>

                    <div class="mt-auto">
                        <template x-if="device.type === 'vps'">
                            <div class="space-y-2">
                                <div class="flex items-center bg-zinc-50 dark:bg-zinc-900/50 rounded-lg pr-1 border border-zinc-100 dark:border-zinc-800">
                                    <div class="px-3 py-1.5 text-[10px] font-mono text-brand truncate flex-grow" x-text="device.sshUrl"></div>
                                    <button @click="navigator.clipboard.writeText(device.sshUrl)" class="p-1 hover:text-brand text-zinc-400 transition-colors">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                    </button>
                                </div>
                                <a :href="'ssh://' + device.sshUrl" class="block w-full py-2 bg-zinc-900 dark:bg-brand text-white rounded-lg text-center font-bold text-xs hover:opacity-90 transition-all">SSH Connect</a>
                            </div>
                        </template>
                        <template x-if="device.type === 'pc'">
                            <a :href="device.link" target="_blank" class="block w-full py-2 bg-brand text-white rounded-lg text-center font-bold text-xs hover:bg-emerald-600 transition-all shadow-lg shadow-emerald-500/10">Remote Link</a>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <footer x-show="pageLoaded" x-transition:enter="transition ease-out duration-1000 delay-500" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        class="py-8 border-t border-zinc-200 dark:border-darkBorder">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <p class="text-[11px] font-medium tracking-[0.2em] uppercase text-zinc-400 dark:text-zinc-600">
                machine deck. shaurya.
            </p>
        </div>
    </footer>

    <div x-show="showModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-md" x-cloak x-transition.opacity>
        <div @click.away="showModal = false" class="bg-white dark:bg-darkCard w-full max-w-md p-8 rounded-2xl border border-zinc-200 dark:border-darkBorder shadow-2xl">
            <h2 class="text-xl font-bold mb-6 dark:text-zinc-50" x-text="editIndex === null ? 'Add Machine' : 'Edit Machine'"></h2>
            <form @submit.prevent="saveDevice()" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 flex gap-3">
                        <div class="flex-grow">
                            <label class="block text-[10px] font-bold uppercase text-zinc-400 mb-1.5 tracking-wider">Name</label>
                            <input x-model="form.name" type="text" class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-2.5 outline-none dark:text-white" required>
                        </div>
                        <div class="w-24">
                            <label class="block text-[10px] font-bold uppercase text-zinc-400 mb-1.5 tracking-wider">Status</label>
                            <select x-model="form.status" class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-2 py-2.5 outline-none dark:text-white">
                                <option value="online">Online</option>
                                <option value="offline">Offline</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold uppercase text-zinc-400 mb-1.5 tracking-wider">Description</label>
                        <input x-model="form.description" type="text" placeholder="Short summary of this machine..." class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-2.5 outline-none dark:text-white">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-zinc-400 mb-1.5 tracking-wider">CPU</label>
                        <input x-model="form.specs_cpu" type="text" class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-2.5 outline-none dark:text-white">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-zinc-400 mb-1.5 tracking-wider">RAM</label>
                        <input x-model="form.specs_ram" type="text" class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-2.5 outline-none dark:text-white">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-zinc-400 mb-1.5 tracking-wider">Image URL (Optional)</label>
                    <input x-model="form.imageUrl" type="url" class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-2.5 outline-none dark:text-white">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-zinc-400 mb-1.5 tracking-wider">Type</label>
                    <select x-model="form.type" class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-darkBorder rounded-xl px-4 py-2.5 outline-none dark:text-white">
                        <option value="pc">PC</option>
                        <option value="vps">Server</option>
                    </select>
                </div>
                <div x-show="form.type === 'pc'"><input x-model="form.link" type="url" placeholder="Remote URL" class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-2.5 outline-none dark:text-white"></div>
                <div x-show="form.type === 'vps'"><input x-model="form.sshUrl" type="text" placeholder="SSH Host" class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-2.5 outline-none dark:text-white"></div>
                <div class="pt-4 flex gap-3">
                    <button type="button" @click="showModal = false" class="flex-1 py-2.5 font-semibold text-zinc-500 text-sm">Cancel</button>
                    <button type="submit" class="flex-1 py-2.5 rounded-xl bg-brand text-white font-bold text-sm">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                darkMode: localStorage.getItem('theme') === 'dark',
                pageLoaded: false,
                showModal: false,
                editIndex: null,
                devices: [],
                form: { name: '', description: '', type: 'pc', link: '', sshUrl: '', specs_cpu: '', specs_ram: '', imageUrl: '', status: 'online' },
                
                initPage() {
                    const masterData = JSON.parse(localStorage.getItem('my_devices_latest') || '[]');
                    this.devices = masterData;

                    // REGISTER PWA SERVICE WORKER
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('./sw.js')
                            .then(() => console.log("PWA Active"))
                            .catch(err => console.log("PWA Error", err));
                    }

                    setTimeout(() => { this.pageLoaded = true; }, 100);
                },

                async toggleTheme(event) {
                    const x = event.clientX;
                    const y = event.clientY;
                    const endRadius = Math.hypot(Math.max(x, innerWidth - x), Math.max(y, innerHeight - y));

                    if (!document.startViewTransition) {
                        this.performThemeToggle();
                        return;
                    }

                    const transition = document.startViewTransition(() => {
                        this.performThemeToggle();
                    });

                    transition.ready.then(() => {
                        document.documentElement.animate(
                            {
                                clipPath: [
                                    `circle(0px at ${x}px ${y}px)`,
                                    `circle(${endRadius}px at ${x}px ${y}px)`,
                                ],
                            },
                            {
                                duration: 500,
                                easing: "ease-in-out",
                                pseudoElement: "::view-transition-new(root)",
                            }
                        );
                    });
                },

                performThemeToggle() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('theme', this.darkMode ? 'dark' : 'light');
                    document.documentElement.style.backgroundColor = this.darkMode ? '#09090b' : '#f9fafb';
                },

                getDisplayImage(device) {
                    if (device.imageUrl && device.imageUrl.trim() !== '') return device.imageUrl;
                    if (device.link && device.link.trim() !== '') return `https://s0.wp.com/mshots/v1/${encodeURIComponent(device.link)}?w=600`;
                    return 'https://images.unsplash.com/photo-1555066931-4365d14bab8c?auto=format&fit=crop&q=80&w=600';
                },
                openAddModal() { 
                    this.editIndex = null; 
                    this.form = { name: '', description: '', type: 'pc', link: '', sshUrl: '', specs_cpu: '', specs_ram: '', imageUrl: '', status: 'online' }; 
                    this.showModal = true; 
                },
                editDevice(index) { this.editIndex = index; this.form = { ...this.devices[index] }; this.showModal = true; },
                saveDevice() {
                    if (this.editIndex !== null) this.devices[this.editIndex] = { ...this.form };
                    else this.devices.push({ ...this.form });
                    this.persist();
                    this.showModal = false;
                },
                removeDevice(index) { if(confirm('Delete?')) { this.devices.splice(index, 1); this.persist(); } },
                persist() { localStorage.setItem('my_devices_latest', JSON.stringify(this.devices)); }
            }
        }
    </script>
</body>
</html>